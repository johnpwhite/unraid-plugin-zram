Menu="Dashboard:0"
Icon="unraid-zram-card.png"
---
<?php
// Standardized Logger
function zram_log($msg, $level = 'DEBUG') {
    $dir = '/tmp/unraid-zram-card';
    $ini = '/boot/config/plugins/unraid-zram-card/settings.ini';
    $level = strtoupper($level);
    
    // Only log DEBUG if explicitly enabled
    if ($level === 'DEBUG') {
        $loaded = @parse_ini_file($ini);
        if (($loaded['debug'] ?? 'no') !== 'yes') return;
    }
    
    if (!is_dir($dir)) @mkdir($dir, 0777, true);
    $logMsg = date('[Y-m-d H:i:s] ') . "[$level] $msg\n";
    @file_put_contents($dir . '/debug.log', $logMsg, FILE_APPEND);
    @chmod($dir . '/debug.log', 0666);
}

zram_log("Dashboard Page Loaded", 'DEBUG');

try {
    $docroot = $docroot ?? $_SERVER['DOCUMENT_ROOT'] ?: '/usr/local/emhttp';
    $includeFile = "{$docroot}/plugins/unraid-zram-card/ZramCard.php";

    if (file_exists($includeFile)) {
        zram_log("Including file: $includeFile", 'DEBUG');
        require_once $includeFile;
        
        if (function_exists('getZramDashboardCard')) {
            zram_log("Calling getZramDashboardCard...", 'DEBUG');
            $content = getZramDashboardCard();
            $mytiles['unraid-zram-card']['column2'] = $content;
            zram_log("Card content assigned (" . strlen($content) . " bytes)", 'DEBUG');
        } else {
            zram_log("Function getZramDashboardCard not found!", 'ERROR');
        }
    } else {
        zram_log("File not found: $includeFile", 'ERROR');
    }
} catch (Throwable $e) {
    zram_log("EXCEPTION: " . $e->getMessage(), 'ERROR');
    if (ob_get_level() > 0) ob_end_clean();
}
?>