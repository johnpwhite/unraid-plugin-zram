Menu="Utilities"
Title="Unraid ZRAM Card"
Icon="database"
---
<?php
$configFile = "/boot/config/plugins/unraid-zram-card/settings.ini";
$defaults = [
    'enabled' => 'yes', 
    'refresh_interval' => '3000', 
    'swap_size' => '1G',
    'zram_devices' => '',
    'compression_algo' => 'zstd'
];

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['save_settings'])) {
    $settings = $defaults;
    $settings['enabled'] = ($_POST['enabled'] === 'yes') ? 'yes' : 'no';
    $settings['refresh_interval'] = intval($_POST['refresh_interval']);
    $settings['swap_size'] = $_POST['swap_size'] ?: '1G';
    $settings['compression_algo'] = $_POST['compression_algo'] ?: 'zstd';
    
    if (file_exists($configFile)) {
        $loaded = @parse_ini_file($configFile);
        $settings['zram_devices'] = $loaded['zram_devices'] ?? '';
    }

    if (!is_dir(dirname($configFile))) mkdir(dirname($configFile), 0777, true);
    $res = [];
    foreach($settings as $key => $val) $res[] = "$key=\"$val\"";
    file_put_contents($configFile, implode("\n", $res));
    echo "<div class='updated'>Settings Saved</div>";
}

$settings = $defaults;
if (file_exists($configFile)) {
    $loaded = @parse_ini_file($configFile);
    if ($loaded) $settings = array_merge($defaults, $loaded);
}

// Get detailed device list
$zram_raw = [];
exec('zramctl --noheadings --raw --output NAME,DISKSIZE,DATA,COMPR,ALGORITHM', $zram_raw);
$devices = [];
foreach ($zram_raw as $line) {
    $parts = preg_split('/
+/', trim($line));
    if (count($parts) >= 2) {
        $devices[] = ['name' => $parts[0], 'size' => $parts[1], 'algo' => $parts[4] ?? ''];
    }
}

// Get Supported Algorithms
$algos = ['zstd', 'lz4', 'lzo', 'deflate', '842'];
if (file_exists('/sys/block/zram0/comp_algorithm')) {
    $raw_algos = file_get_contents('/sys/block/zram0/comp_algorithm');
    $raw_algos = str_replace(['[', ']'], '', $raw_algos);
    $algos = preg_split('/
+/', trim($raw_algos));
}
?>

<style>
    .zram-main-grid { display: flex; gap: 20px; flex-wrap: nowrap; align-items: flex-start; width: 100%; }
    .zram-config-left { flex: 0 0 450px; }
    .zram-console-right { flex: 1; background: #1a1a1a; border-radius: 4px; border: 1px solid #333; padding: 15px; color: #aaa; font-family: monospace; font-size: 0.85em; min-width: 300px; }
    
    .zram-btn { padding: 5px 12px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; margin-right: 5px; font-size: 0.9em; display: inline-block; vertical-align: middle; }
    .btn-create { background-color: #7fba59; color: white; }
    .btn-remove { background-color: #d9534f; color: white; }
    .btn-small { padding: 2px 8px; font-size: 0.8em; }
    
    .status-badge { padding: 3px 10px; border-radius: 12px; font-size: 0.85em; display: inline-block; }
    .status-active { background: #7fba59; color: white; }
    .status-none { background: #666; color: white; }
    
    .dev-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .dev-table th { text-align: left; border-bottom: 1px solid #444; padding: 5px; opacity: 0.7; font-size: 0.85em; }
    .dev-table td { padding: 8px 5px; border-bottom: 1px solid #333; font-size: 0.9em; }
    
    .action-row { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 4px; margin-bottom: 20px; }
    #console-log { height: 350px; overflow-y: auto; color: #00ff00; }
    .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
    .log-err { color: #ff5555; }
    .log-cmd { color: #5555ff; font-weight: bold; }
    .log-debug { color: #888; padding-left: 10px; font-style: italic; }
</style>

<div class="zram-main-grid">
    <div class="zram-config-left">
        <div class="section">
            <h3>ZRAM Swap Management</h3>
            <div class="action-row">
                <div style="margin-bottom: 10px;">
                    <span style="display: inline-block; width: 100px;">Size:</span>
                    <input type="text" id="swap_size_val" value="<?php echo htmlspecialchars($settings['swap_size']); ?>" style="width: 80px; text-align: center;">
                    <span style="opacity: 0.6; font-size: 0.8em;">(e.g. 1G, 512M)</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <span style="display: inline-block; width: 100px;">Algorithm:</span>
                    <select id="swap_algo_val" style="width: 80px;">
                        <?php foreach ($algos as $a): ?>
                            <option value="<?php echo $a; ?>" <?php echo ($settings['compression_algo'] == $a) ? 'selected' : ''; ?>><?php echo $a; ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div>
                    <button type="button" class="zram-btn btn-create" onclick="manageZram('create')">Add Device</button>
                    <button type="button" class="zram-btn btn-remove" onclick="manageZram('remove', '')">Remove All</button>
                </div>
            </div>

            <h4 style="margin-top: 10px;">Active Devices: 
                <?php if (count($devices) > 0): ?>
                    <span class="status-badge status-active">Active (<?php echo count($devices); ?>)</span>
                <?php else:
                ?>
                    <span class="status-badge status-none">None</span>
                <?php endif; ?>
            </h4>
            
            <?php if (count($devices) > 0): ?>
                <table class="dev-table">
                    <thead><tr><th>Device</th><th>Size</th><th>Algorithm</th><th style="text-align: right;">Action</th></tr></thead>
                    <tbody>
                        <?php foreach ($devices as $dev):
                        ?>
                        <tr>
                            <td><strong>/dev/<?php echo $dev['name']; ?></strong></td>
                            <td><?php echo $dev['size']; ?></td>
                            <td><span style="background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 3px; font-family: monospace;"><?php echo $dev['algo']; ?></span></td>
                            <td style="text-align: right;">
                                <button type="button" class="zram-btn btn-remove btn-small" onclick="manageZram('remove', '<?php echo $dev['name']; ?>')">Remove</button>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            <?php endif; ?>
        </div>

        <form method="post" action="/Settings/UnraidZramCard">
            <div class="section">
                <h3>Dashboard Card Configuration</h3>
                <dl>
                    <dt>Enable Dashboard Card:</dt>
                    <dd><select name="enabled"><option value="yes" <?php echo ($settings['enabled'] == 'yes') ? 'selected' : ''; ?>>Yes</option><option value="no" <?php echo ($settings['enabled'] == 'no') ? 'selected' : ''; ?>>No</option></select></dd>
                    <dt>Refresh Interval (ms):</dt>
                    <dd><input type="number" name="refresh_interval" value="<?php echo htmlspecialchars($settings['refresh_interval']); ?>" min="1000"></dd>
                    <dt>Default Swap Size:</dt>
                    <dd><input type="text" name="swap_size" value="<?php echo htmlspecialchars($settings['swap_size']); ?>"></dd>
                    <dt>Default Algorithm:</dt>
                    <dd><select name="compression_algo"><?php foreach ($algos as $a): ?><option value="<?php echo $a; ?>" <?php echo ($settings['compression_algo'] == $a) ? 'selected' : ''; ?>><?php echo $a; ?></option><?php endforeach; ?></select></dd>
                </dl>
            </div>
            <div class="section"><input type="submit" name="save_settings" value="Save Settings"></div>
        </form>
    </div>

    <div class="zram-console-right">
        <h4 style="margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 5px;">Command Console</h4>
        <div id="console-log"></div>
        <div style="margin-top: 10px; border-top: 1px solid #444; padding-top: 10px;">
            <button class="zram-btn" style="background: #444; color: #fff; width: 100%;" onclick="clearPersistentLogs()">Clear Console</button>
        </div>
    </div>
</div>

<script>
function renderLog(entry) {
    const log = document.getElementById('console-log');
    const div = document.createElement('div');
    div.className = 'log-entry ' + (entry.type ? 'log-' + entry.type : '');
    div.innerText = `[${entry.time}] ${entry.msg}`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
}

function addLog(msg, type = '') {
    const entry = { time: new Date().toLocaleTimeString(), msg: msg, type: type };
    let logs = JSON.parse(sessionStorage.getItem('zram_console_logs') || '[]');
    logs.push(entry);
    sessionStorage.setItem('zram_console_logs', JSON.stringify(logs));
    renderLog(entry);
}

function clearPersistentLogs() {
    sessionStorage.removeItem('zram_console_logs');
    document.getElementById('console-log').innerHTML = '';
    addLog('Console cleared.');
}

function manageZram(action, device) {
    const size = document.getElementById('swap_size_val').value;
    const algo = document.getElementById('swap_algo_val').value;
    const btn = event.target;
    
    addLog(`Initiating ${action} (Target: ${device || 'ALL'})...`, 'cmd');
    btn.disabled = true;

    $.post('/plugins/unraid-zram-card/zram_swap.php', {
        action: action, size: size, algo: algo, device: device
    }, function(data) {
        if (data.logs && Array.isArray(data.logs)) {
            data.logs.forEach(log => {
                if (typeof log === 'string') {
                    addLog(log);
                } else {
                    const status = log.status === 0 ? 'Success' : 'Fail';
                    addLog(`${log.cmd} -> ${status}`, log.status === 0 ? '' : 'err');
                    if (log.output) addLog(`  > ${log.output}`, 'debug');
                }
            });
        }

        if (data.success) {
            addLog(`Completed: ${data.message}`);
            setTimeout(() => location.reload(), 3000);
        } else {
            addLog(`CRITICAL ERROR: ${data.message}`, 'err');
            btn.disabled = false;
        }
    }).fail(function() {
        addLog('Request failed (Server Error)', 'err');
        btn.disabled = false;
    });
}

$(function() {
    const logs = JSON.parse(sessionStorage.getItem('zram_console_logs') || '[]');
    if (logs.length === 0) {
        addLog('Console initialized. Ready for commands...');
    } else {
        logs.forEach(renderLog);
    }
});
</script>